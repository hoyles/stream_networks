---
title: Stream network models in VAST
author: "Merrill Rudd"
date: "`r Sys.Date()`"
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
  html_document:
    number_sections: yes
    toc: yes
html_document:
  toc: yes
---

# Overview
This tutorial provides an example for setting up a stream network model in `VAST` using New Zealand longfin eel data. 

Please see the single-species or multi-species example documents provided with `VAST` for information on package installation and citation.

```{r load_packages, include=FALSE}
## loads FishStatsUtils
devtools::install_github("merrillrudd/VAST")
library(VAST)

devtools::install_github("merrillrudd/FishStatsUtils")
library(FishStatsUtils)

library(TMB)
library(dplyr)
```

# Data

Datasets for stream models in `VAST` require observations by segment, with each segment defined by a parent and child node. Thus, connectivity between stream segments is defined by shared parent nodes rather than simply Euclidean distance. 

Many example data sets are archived with the `VAST` and `FishStatsUtils` R packages. We will use the New Zealand longfin eel data to demonstrate the stream network model:
```{r choose_data, tidy=TRUE, linewidth=60}
Data_Set = c("NZ_longfin_eel", "Chatham_rise_hake", "Iceland_cod", "WCGBTS_canary", "GSL_american_plaice", "BC_pacific_cod", "EBS_pollock", "GOA_Pcod", "GOA_pollock", "GB_spring_haddock", "GB_fall_haddock", "SAWC_jacopever", "Aleutian_islands_POP")[1]

data(NZ_longfin_eel, package="FishStatsUtils")
```

In the eel dataset, there are 8,038 unique segments with 10,539 observations of longfin eels being either present or absent over 41 years (1974-2014). These segments are defined by a total of 14,338 nodes that can be defined as either a parent (upstream) or child (downstream). 

There are 1,889 parent nodes that are also child nodes (i.e. 24% of segments are connected directly to another segment upstream) and 1,887 child nodes are also parent nodes (i.e. 23% of segments are connected directly to another segment downstream). This leaves a large percentage of segments disconnected from other segments, which is a possible reason for some of the convergence issues that come up as we start running models with a spatial component. 


## Visualize data

The first step is to set up the unique parent and child nodes with the length between them. If available, the length should be total stream length between the two nodes, as opposed to the Euclidean distance between the two nodes. 

```{r raw_data, include=FALSE}
info <- NZ_longfin_eel %>% select(c(nz_fnode, nz_tnode, Shape_length))

nodes <- unique(c(NZ_longfin_eel[,'nz_fnode'], NZ_longfin_eel[,'nz_tnode']))
Network_sz_raw <- lapply(1:length(nodes), function(x){
	find_parents <- which(info[,'nz_fnode']==nodes[x])
	find_children <- which(info[,'nz_tnode']==nodes[x])
	sub <- rbind(unique(info[find_parents,]), unique(info[find_children,]))
	return(sub)
})
Network_sz_raw <- do.call(rbind, Network_sz_raw)

## change sites to start at 1
snodes <- unique(c(Network_sz_raw[,'nz_fnode'],Network_sz_raw[,'nz_tnode']))
inodes <- seq_along(snodes)
Network_sz <- lapply(1:nrow(Network_sz_raw), function(x){
	p <- inodes[which(snodes == Network_sz_raw[x,'nz_fnode'])]
	c <- inodes[which(snodes == Network_sz_raw[x,'nz_tnode'])]
	return(data.frame('parent_s'=p, 'child_s'=c, 'dist_s'=Network_sz_raw[x,'Shape_length']))
})
Network_sz <- do.call(rbind, Network_sz)
```

The stream network spatial model in VAST requires a dataframe `Network_sz` in the following format:
```{r head_data}
head(Network_sz)
```



# Settings

First we make sure we're using the latest version for CPP code:
```{r version}
Version = get_latest_version( package="VAST")
```

## Spatial settings

The following settings define the spatial resolution for the model. While `n_x` defines the number of knots in a grid, mesh, or spherical mesh, for stream networks we use the number of parent or child nodes.


